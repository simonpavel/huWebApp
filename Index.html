<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hungarian Words</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4CAF50" />
</head>

<body>
  <div class="container">
    <p id="wordlistCount">Words Count: …</p>

    <div class="controls">
      <select id="wordlistSelect" class="dropdown"></select>

      <input
        type="number"
        id="wordCount"
        min="1"
        value="10"
        inputmode="numeric"
      />

      <button id="btnGenerate">Generate</button>
      <button id="btnGenerateHu">HU</button>
      <button id="btnTranslate">Translate</button>
      <button id="btnClear">Clear</button>
    </div>

    <div class="addRow">
      <input type="text" id="newWordEntry" placeholder="Достаточно: elég" />
      <button id="btnAdd" class="btnBlue">Add</button>
    </div>

    <div id="output" class="output"></div>
  </div>

<script>
  // === Настройка: список файлов словарей (у тебя он был захардкожен в HTML) :contentReference[oaicite:3]{index=3}
  const WORDLIST_FILES = [
    "worldList_1.JSON",
    "Группа Восприятие (видеть, слышать).JSON",
    "Группа Движение и транспорт.JSON",
    "Группа Еда и напитки.JSON",
    // добавляй остальные по мере надобности
  ];

  const STORAGE_KEY_LAST = "hw_last_generated";
  const STORAGE_KEY_CUSTOM_PREFIX = "hw_custom_words__"; // + filename

  let selectedWordList = WORDLIST_FILES[0];
  let lastGenerated = []; // [{key:value}, ...]

  // ===== helpers
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function parseEntry(entry) {
    // "Достаточно: elég" -> { "Достаточно": "elég" }
    const parts = entry.split(":");
    if (parts.length < 2) return null;
    const key = parts[0].trim();
    const value = parts.slice(1).join(":").trim();
    if (!key || !value) return null;
    return { [key]: value };
  }

  function shuffle(arr) {
    // Fisher-Yates
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function getCustomWords(filename) {
    const raw = localStorage.getItem(STORAGE_KEY_CUSTOM_PREFIX + filename);
    if (!raw) return [];
    try { return JSON.parse(raw); } catch { return []; }
  }

  function setCustomWords(filename, words) {
    localStorage.setItem(STORAGE_KEY_CUSTOM_PREFIX + filename, JSON.stringify(words));
  }

  async function loadWordList(filename) {
    // Берем основной JSON + добавленные в localStorage
    const res = await fetch(filename, { cache: "no-store" });
    if (!res.ok) throw new Error("Cannot load " + filename);
    const base = await res.json();

    const custom = getCustomWords(filename);
    return base.concat(custom);
  }

  function renderCount(count) {
    document.getElementById("wordlistCount").textContent = `Words Count: ${count}`;
  }

  function renderLines(lines) {
    const out = document.getElementById("output");
    out.innerHTML = lines.map(l => `<div class="line">${escapeHtml(l)}</div>`).join("");
  }

  async function updateWordListCount() {
    const list = await loadWordList(selectedWordList);
    renderCount(list.length);
  }

  async function generateWords(showHungarianOnly = false) {
    const n = parseInt(document.getElementById("wordCount").value, 10);
    if (!Number.isFinite(n) || n <= 0) {
      alert("Введите корректное число");
      return;
    }

    const list = await loadWordList(selectedWordList);
    const picked = shuffle(list).slice(0, Math.min(n, list.length));
    lastGenerated = picked;
    localStorage.setItem(STORAGE_KEY_LAST, JSON.stringify(lastGenerated));

    const lines = showHungarianOnly
      ? picked.map(o => Object.values(o)[0])
      : picked.map(o => Object.keys(o)[0]);

    renderLines(lines);
    await updateWordListCount();
  }

  function retrieveSavedWords() {
    const raw = localStorage.getItem(STORAGE_KEY_LAST);
    if (!raw) {
      alert("Нет сохранённых слов. Сначала Generate.");
      return;
    }
    try { lastGenerated = JSON.parse(raw); } catch { lastGenerated = []; }

    const lines = lastGenerated.map(o => `${Object.keys(o)[0]}: ${Object.values(o)[0]}`);
    renderLines(lines);
  }

  async function addNewWord() {
    const input = document.getElementById("newWordEntry");
    const entry = input.value.trim();
    const obj = parseEntry(entry);

    if (!obj) {
      alert("Формат: слово: перевод");
      return;
    }

    const custom = getCustomWords(selectedWordList);
    custom.push(obj);
    setCustomWords(selectedWordList, custom);

    input.value = "";
    await updateWordListCount();
    alert("Добавлено (сохранено на этом устройстве).");
  }

  function clearOutput() {
    document.getElementById("output").innerHTML = "";
  }

  // ===== init
  function initSelect() {
    const sel = document.getElementById("wordlistSelect");
    sel.innerHTML = WORDLIST_FILES
      .map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f.replace(".JSON",""))}</option>`)
      .join("");

    sel.value = selectedWordList;
    sel.addEventListener("change", async () => {
      selectedWordList = sel.value;
      await updateWordListCount();
      clearOutput();
    });
  }

  document.getElementById("btnGenerate").addEventListener("click", () => generateWords(false));
  document.getElementById("btnGenerateHu").addEventListener("click", () => generateWords(true));
  document.getElementById("btnTranslate").addEventListener("click", retrieveSavedWords);
  document.getElementById("btnClear").addEventListener("click", clearOutput);
  document.getElementById("btnAdd").addEventListener("click", addNewWord);

  document.getElementById("wordCount").addEventListener("keydown", (e) => {
    if (e.key === "Enter") generateWords(false);
  });

  window.addEventListener("load", async () => {
    initSelect();
    await updateWordListCount();

    // PWA service worker
    if ("serviceWorker" in navigator) {
      try { await navigator.serviceWorker.register("./sw.js"); } catch {}
    }
  });
</script>
</body>
</html>
